# 慢查询
1. 默认不开启，开启后对性能有一定影响，但是再可接收的范围，一般不再生产环境开启，而是再DEV、SIT、UAT等环境下面开启这个功能
   DEV环境：DEV顾名思义就是develop，即代码开发的环境。
   SIT环境：System Integration Test系统集成测试，开发人员自己测试流程是否走通。
   UAT环境：User Acceptance Test用户验收测试，由专门的测试人员验证，验收完成才能上生产环境。
2. 检查是否已经开启了慢查询日志
```sql
   show variables like 'slow_%'
   
   结果：
   slow_launch_time	2
   slow_query_log	ON   #on或者1表示已经开启了慢查询日志记录的功能，off或者0表示没有开启
   slow_query_log_file	/var/lib/mysql/data/slow.log   #慢查询日志存放的位置，默认的文件名称为 服务器主机名称-slow.log 默认的日志存储路径为变量：datadir的值所指向的目录
   slow_query_log_use_global_control	
```

   如果未开启，则开启命令如下：
   set global slow_query_log=1
   这样配置后就可以生效，但是重启后会失效，所以还需要再配置文件中进行配置

3. 常用的日志参数配置

   show variables like 'long_query_time'  #long_query_time 决定一个sql语句是否是慢查询的阈值，默认10秒，如果设置0表示记录所有的sql语句
   
   select sleep(11);  表示执行一个11秒的sql语句
   
   show variables like 'log_timestamps'  #查询日志记录的时区，默认是UTC
   
   配置文件配置项
      
```text
       [mysqld]
       #设置日志中记录日志记录的时候使用的时间，避免和系统时间差8个小时的问题
        log_timestamps=system
   
      ############## 慢查询日志配置相关 #######################################
      slow_query_log=1 
      # 慢查询日志记录在mysql.slow_log表中,它们的值可以是table、file或者table,file3中情况，如果记录在表中则表名就是mysql.slow_log
      log_output=table,file
      slow_query_log_file=/var/lib/mysql/test-slow.log
       # 慢查询日志的SQL耗时的阈值
       long_query_time=10
       # 对没有使用索引的SQL，即便是查询耗时低于10s，也记录日志 
       #log_queries_not_using_indexes=1 
       # 对没有使用索引的SQL，即便是查询耗时低于10s，也记录日志，但是一分钟内置记录1次。
        #log_throttle_queries_not_using_indexes=1 
        # 没有使用索引的SQL，如果扫描的行数低于1000，则不记录到慢查询日志中 
        #min_examined_row_limit=1000 
        # alter，analyze语句，如果超过慢查询的阈值，也记录在慢查询日志中 
        #log_slow_admin_statements=1 
        ############### 慢查询日志配置相关 ####################################### 

```
   
4. 慢查询日志解读

* 通过日志文件来查看
```text
/usr/sbin/mysqld, Version: 5.7.32-log (MySQL Community Server (GPL)). started with:
Tcp port: 3306  Unix socket: /var/lib/mysql/mysql.sock
Time                 Id Command    Argument
# Time: 2021-01-08T07:48:04.533187Z
# User@Host: root[root] @ localhost []  Id:     2
# Query_time: 11.001556  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0
SET timestamp=1610092084;
select sleep(11);
``` 
可以看到Time的时间和我们的系统时间不对应，所以我们要修改这个配置项log_timestamps，使其为system
set global log_timestamps=system; 重启后会失效，要到配置文件进行配置

```text
# Time: 2021-01-08T16:01:01.977596+08:00  #和系统时间保持了一致
# User@Host: root[root] @ localhost []  Id:     2
# Query_time: 11.002677  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0
SET timestamp=1610092861;
select sleep(11);
```
含义：
Time: 表示这个慢sql发生的时间
User@Host:表示这个sql是由哪个用户通过哪个IP地址访问的
Query_time:表示这个sql语句执行所花费的时间，单位是秒
Lock_time:表示这个sql语句在执行的过程中，锁定表或行的时间
Rows_sent:表示最后查询的结果发送给客户端的行数
Rows_examined：表示这个sql语句在执行的过程中，实际扫描的行数
SET timestamp=1610092861：记录日志的时间
最后就是sql语句的具体内容

* 通过数据表来查询

```text
mysql> select * from slow_log\G
*************************** 1. row ***************************
    start_time: 2021-01-08 16:16:02.739672
     user_host: root[root] @ localhost []
    query_time: 00:00:11.002206
     lock_time: 00:00:00.000000
     rows_sent: 1
 rows_examined: 0
            db: mysql
last_insert_id: 0
     insert_id: 0
     server_id: 1
      sql_text: select sleep(11)
     thread_id: 2
1 row in set (0.00 sec)

```
含义：
start_time:sql语句执行的时间
user_host：执行该sql语句的用户和ip地址
query_time:该sql语句执行所消耗的时间，单位为秒
lock_time：锁表或行的时间。
rows_sent：返回的结果集行数。
rows_examined：实际扫描的记录行数。
db：该SQL语句的是在哪个schema下面执行的。
server_id：在MySQL集群中，数据库实例的编号。
sql_text：SQL语句的具体内容，此处是BLOB字段，不能直接查看，需要时候用CONVERT(sql_text using utf8mb4)函数转换一下[版本不一样，5.7不需要]，再查看具体的SQL内容。
thread_id：线程编号。


* 如何分析慢查询日志文件
最简单的就是通过mysql自带的一个工具mysqldumpslow
使用帮助
mysqldumpslow --help
```text
Usage: mysqldumpslow [ OPTS... ] [ LOGS... ]

Parse and summarize the MySQL slow query log. Options are

  --verbose    verbose
  --debug      debug
  --help       write this text to standard output

  -v           verbose
  -d           debug
  -s ORDER     what to sort by (al, at, ar, c, l, r, t), 'at' is default
                al: average lock time
                ar: average rows sent
                at: average query time
                 c: count
                 l: lock time
                 r: rows sent
                 t: query time  
  -r           reverse the sort order (largest last instead of first)
  -t NUM       just show the top n queries
  -a           don't abstract all numbers to N and strings to 'S'
  -n NUM       abstract numbers with at least n digits within names
  -g PATTERN   grep: only consider stmts that include this string
  -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),
               default is '*', i.e. match all
  -i NAME      name of server instance (if using mysql.server startup script)
  -l           don't subtract lock time from total time

```

例子：
mysqldumpslow
按照query time排序查看日志
  mysqldumpslow -s t test-slow.log> slow.1.dat
按照平均query time排序查看日志
  mysqldumpslow -s at test-slow.log > slow.2.dat 
按照平均query time排序并且不抽象数字的方式排序
  mysqldumpslow -a -s at test-slow.log > slow.3.dat
安装执行次数排序
mysqldumpslow -a -s c test-slow.log > slow.4.dat



   